<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Client | Nexus Res-Q</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-dark: #0d1b2a;   /* Nexus blue background */
      --primary-mid: #142b47;    /* Card/box bg */
      --primary-light: #fdd835;  /* Nexus yellow accent */
      --box-shadow: 0 8px 24px rgba(12,22,44,0.20);
    }
    html, body {
      font-family: 'Oswald', sans-serif;
      background: var(--primary-dark);
      color: #f2f2f2;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .add-client-form {
      max-width: 480px;
      margin: 48px auto;
      padding: 32px 32px 26px 32px;
      background: var(--primary-mid);
      border-radius: 18px;
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .add-client-form label { font-weight: 600; color: var(--primary-light); }
    .add-client-form input {
      <div id="logoPreview" style="margin-top:-8px;"></div>
    .add-client-form select {
      font-family: 'Oswald', sans-serif;
      padding: 10px 11px;
      font-size: 1em;
      border-radius: 7px;
      border: 1.5px solid #212d3d;
      outline: none;
      margin-top: 3px;
      margin-bottom: 8px;
      background: #f8f8f8;
      color: #1c2537;
    }
    .add-client-form input[type="file"] {
      background: none;
      color: #eee;
      border: none;
      padding: 0;
    }
    .add-client-form .submit-btn {
      background: var(--primary-light);
      color: #1c2537;
      border: none;
      border-radius: 7px;
      padding: 12px 0;
      font-weight: 700;
      font-size: 1.08em;
      margin-top: 10px;
      cursor: pointer;
      box-shadow: 0 2px 7px rgba(12,22,44,0.08);
      transition: background 0.12s;
    }
    .add-client-form .submit-btn:hover { background: #ffe357; }
    .form-message { text-align: center; margin-top: 12px; color: #fdd835; min-height: 28px; }
    /* Loader Spinner (Nexus blue/yellow) */
    .loader-4 {
      width: 54px;
      height: 54px;
      border: 4px solid var(--primary-dark);
      border-radius: 50%;
      display: inline-block;
      position: relative;
      animation: rotation 1.05s linear infinite;
      box-sizing: border-box;
      margin-top: 8px;
      margin-bottom: 3px;
    }
    @keyframes rotation {
      0%   { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .loader-4:after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 43px;
      height: 43px;
      border-radius: 50%;
      border: 4px solid;
      border-color: var(--primary-light) transparent;
    }
    /* Responsive form */
    @media (max-width: 700px) {
      .add-client-form {
        padding: 15px 2vw 12px 2vw;
        max-width: 97vw;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <form class="add-client-form" id="addClientForm" enctype="multipart/form-data" autocomplete="off">
    <h2 style="text-align:center;color:var(--primary-light);margin-bottom:8px;">Add New Client</h2>
    <label>Client Name*</label>
    <input type="text" id="clientName" required maxlength="48" autocomplete="off">

    <label>Logo (PNG/JPG, optional)</label>
    <input type="file" id="clientLogo" accept="image/png, image/jpeg, image/webp">
    <div id="logoPreview" style="margin-top:-8px;"></div>

    <label>Primary Color*</label>
    <input type="color" id="clientColor" value="#fdd835" required style="width:60px;height:38px;">

    <label>Admin Username*</label>
    <input type="text" id="adminUsername" required maxlength="32" autocomplete="off">

    <label>Admin Password*</label>
    <input type="password" id="adminPassword" required minlength="6" maxlength="64" autocomplete="new-password">

    <button type="submit" class="submit-btn">Create Client</button>
    <div class="form-message" id="formMessage"></div>
    <div id="formLoader" style="text-align:center; margin:8px 0; display:none;">
      <span class="loader-4"></span>
    </div>
  </form>

  <script>
  let processedLogoBlob = null;

  document.getElementById("clientLogo").addEventListener("change", async function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById("logoPreview");
    preview.innerHTML = "";
    processedLogoBlob = null;

    if (!file) return;

    const img = new Image();
    const reader = new FileReader();

    reader.onload = (event) => { img.src = event.target.result; };
    reader.readAsDataURL(file);

    img.onload = async () => {
      const canvas = document.createElement("canvas");
      const maxSize = 300;
      const scale = Math.min(maxSize / img.width, maxSize / img.height);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(
        (blob) => {
          processedLogoBlob = blob;
          const url = URL.createObjectURL(blob);
          preview.innerHTML = `<img src="${url}" style="max-width:120px;max-height:120px;border-radius:7px;border:1px solid #ccc;margin-top:8px;">`;
        },
        "image/webp",
        0.85
      );
    };
  });
</script>

<script>
  // === SUPABASE SETUP ===
  const supabaseUrl = 'https://vainwbdealnttojooghw.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhaW53YmRlYWxudHRvam9vZ2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNTc3MjAsImV4cCI6MjA2NTkzMzcyMH0.xewtWdupuo6TdQBHwGsd1_Jj6v5nmLbVsv_rc-RqqAU';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  document.getElementById('addClientForm').onsubmit = async function (e) {
    e.preventDefault();
    const msg = document.getElementById('formMessage');
    const loader = document.getElementById('formLoader');
    msg.style.color = "#fdd835";
    msg.textContent = "Creating client...";
    loader.style.display = "inline-block";

    let isDone = false;
    let isStillWorkingShown = false;
    const stillWorking = setTimeout(() => {
      if (!isDone) {
        msg.style.color = "#1ecbe1";
        msg.textContent = "Still working...";
        isStillWorkingShown = true;
      }
    }, 6000); // 6 seconds for "Still working..."

    const giveUp = setTimeout(() => {
      if (!isDone) {
        loader.style.display = "none";
        msg.style.color = "#ff5050";
        msg.textContent = "Request timed out. Please try again or check your connection.";
        isDone = true;
      }
    }, 20000);

    try {
      // 1. Gather form fields
      const clientName = document.getElementById('clientName').value.trim();
      const color = document.getElementById('clientColor').value;
      const adminUsername = document.getElementById('adminUsername').value.trim();
      const adminPassword = document.getElementById('adminPassword').value;

      // 2. Upload logo to Supabase Storage if present
      let logo_url = null;
      if (processedLogoBlob) {
        const filePath = `logos/${clientName.replace(/\s+/g, '_').toLowerCase()}.webp`;
        const { data: storageData, error: storageErr } = await supabase
          .storage
          .from('client-logo-bucket')
          .upload(filePath, processedLogoBlob, {
            contentType: 'image/webp',
            upsert: true
          });

        if (storageErr) {
          throw new Error("Logo upload failed: " + storageErr.message);
        }

        const { data: urlData } = supabase
          .storage
          .from('client-logo-bucket')
          .getPublicUrl(filePath);

        logo_url = urlData?.publicUrl || null;
      }

      // 3. Insert client
      const { data: client, error: clientErr } = await supabase
        .from('clients')
        .insert([{ name: clientName, logo_url, color }])
        .select()
        .single();

      if (clientErr || !client) {
        throw new Error(clientErr?.message || "Unknown error creating client");
      }

      // 4. Insert admin user
      const { error: userErr } = await supabase
        .from('users')
        .insert([{ username: adminUsername, password: adminPassword, role: 'admin', tenant_id: client.id }]);

      if (userErr) {
        throw new Error("Client created, but failed to add admin user: " + userErr.message);
      }

      isDone = true;
      clearTimeout(stillWorking);
      clearTimeout(giveUp);
      loader.style.display = "none";
      msg.style.color = "#28e640";
      msg.textContent = "✅ Client onboarded! UUID: " + client.id;
      this.reset();

    } catch (err) {
      isDone = true;
      clearTimeout(stillWorking);
      clearTimeout(giveUp);
      loader.style.display = "none";
      msg.style.color = "#ff5050";
      msg.textContent = "❌ " + (err.message || err || "Unknown error");
    }
  }
</script>
