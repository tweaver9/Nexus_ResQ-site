<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Client | Nexus Res-Q</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .add-client-form {
      max-width: 480px;
      margin: 38px auto;
      padding: 30px 32px 26px 32px;
      background: var(--primary-mid, #182848);
      border-radius: 16px;
      box-shadow: var(--box-shadow, 0 8px 24px rgba(12,22,44,0.14));
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .add-client-form label { font-weight: 600; color: var(--primary-light); }
    .add-client-form input,
    .add-client-form select {
      font-family: 'Oswald', sans-serif;
      padding: 10px 11px;
      font-size: 1em;
      border-radius: 7px;
      border: 1.5px solid #212d3d;
      outline: none;
      margin-top: 3px;
      margin-bottom: 9px;
      background: #f8f8f8;
      color: #1c2537;
    }
    .add-client-form input[type="file"] {
      background: none;
      color: #eee;
      border: none;
      padding: 0;
    }
    .add-client-form .submit-btn {
      background: var(--primary-light);
      color: #1c2537;
      border: none;
      border-radius: 7px;
      padding: 11px 0;
      font-weight: 700;
      font-size: 1.08em;
      margin-top: 7px;
      cursor: pointer;
      box-shadow: 0 2px 7px rgba(12,22,44,0.08);
      transition: background 0.12s;
    }
    .add-client-form .submit-btn:hover { background: #ffe357; }
    .form-message { text-align: center; margin-top: 10px; color: #fdd835; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <form class="add-client-form" id="addClientForm" enctype="multipart/form-data">
    <h2>Add New Client</h2>
    <label>Client Name*</label>
    <input type="text" id="clientName" required maxlength="48">

    <label>Logo (PNG/JPG, optional)</label>
    <input type="file" id="clientLogo" accept="image/png, image/jpeg">

    <label>Primary Color*</label>
    <input type="color" id="clientColor" value="#fdd835" required style="width:60px;height:40px;">

    <label>Admin Username*</label>
    <input type="text" id="adminUsername" required maxlength="32">

    <label>Admin Password*</label>
    <input type="password" id="adminPassword" required minlength="6" maxlength="64">

    <button type="submit" class="submit-btn">Create Client</button>
    <div class="form-message" id="formMessage"></div>
  </form>

  <script>
    // === SUPABASE SETUP ===
    const supabaseUrl = 'https://vainwbdealnttojooghwi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhaW53YmRlYWxudHRvam9vZ2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNTc3MjAsImV4cCI6MjA2NTkzMzcyMH0.xewtWdupuo6TdQBHwGsd1_Jj6v5nmLbVsv_rc-RqqAU';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // === FORM HANDLER ===
    document.getElementById('addClientForm').onsubmit = async function (e) {
      e.preventDefault();
      const msg = document.getElementById('formMessage');
      msg.textContent = "Creating client...";

      const clientName = document.getElementById('clientName').value.trim();
      const color = document.getElementById('clientColor').value;
      const adminUsername = document.getElementById('adminUsername').value.trim();
      const adminPassword = document.getElementById('adminPassword').value;
      const logoFile = document.getElementById('clientLogo').files[0];

      // 1. Create client (insert into 'clients')
      let logo_url = null;
      if (logoFile) {
        // upload logo to Supabase Storage
        const ext = logoFile.name.split('.').pop();
        const fileName = `logos/${clientName.replace(/\s+/g, '_').toLowerCase()}_${Date.now()}.${ext}`;
        const { data: storageData, error: storageErr } = await supabase.storage.from('client-logos').upload(fileName, logoFile);
        if (storageErr) {
          msg.textContent = "Logo upload failed: " + storageErr.message;
          return;
        }
        const { data: publicUrl } = supabase.storage.from('client-logos').getPublicUrl(fileName);
        logo_url = publicUrl?.publicUrl || null;
      }

      const { data: client, error: clientErr } = await supabase
        .from('clients')
        .insert([{ name: clientName, logo_url, color }])
        .select()
        .single();

      if (clientErr || !client) {
        msg.textContent = "Failed to add client: " + (clientErr?.message || "Unknown error");
        return;
      }

      // 2. Add admin user (insert into 'users' with correct tenant_id)
      const { error: userErr } = await supabase
        .from('users')
        .insert([{ username: adminUsername, password: adminPassword, role: 'admin', tenant_id: client.id }]);
      if (userErr) {
        msg.textContent = "Client created, but failed to add admin user: " + userErr.message;
        return;
      }

      msg.textContent = "Client onboarded! UUID: " + client.id;
      this.reset();
    }
  </script>
</body>
</html>
