<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Client | Nexus Res-Q</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="CSS/add-client.css">
  <!-- Color Extraction & Manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/node-vibrant/dist/vibrant.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinycolor2@1.6.0/dist/tinycolor-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <form class="add-client-form" id="addClientForm" enctype="multipart/form-data" autocomplete="off">
    <h2 style="text-align:center;color:var(--primary-light);margin-bottom:8px;">Add New Client</h2>
    <label>Client Name*</label>
    <input type="text" id="clientName" required maxlength="48" autocomplete="off">

    <label>Logo (PNG/JPG/WebP, optional)</label>
    <input type="file" id="clientLogo" accept="image/png, image/jpeg, image/webp">
    <div id="logoPreview" style="margin-top:-8px;"></div>
    <div id="colorPreview" style="margin: 10px 0 5px 0; text-align:center;"></div>

    <!-- Hidden color fields to be auto-filled -->
    <input type="hidden" id="primaryColor" value="#142b47">
    <input type="hidden" id="secondaryColor" value="#fdd835">
    <input type="hidden" id="darkColor" value="#0d1b2a">

    <label>Admin Username*</label>
    <input type="text" id="adminUsername" required maxlength="32" autocomplete="off">

    <label>Admin Password*</label>
    <input type="password" id="adminPassword" required minlength="6" maxlength="64" autocomplete="new-password">

    <button type="submit" class="submit-btn">Create Client</button>
    <div class="form-message" id="formMessage"></div>
    <div id="formLoader" style="text-align:center; margin:8px 0; display:none;">
      <span class="loader-4"></span>
    </div>
    <button type="button" id="returnToPortalBtn" style="display:none;margin-top:16px;"
        onclick="window.location.href='client-portal.html'">
  Return to Client Portal
</button>
  </form>
  <script>
  let processedLogoBlob = null;

  document.getElementById("clientLogo").addEventListener("change", async function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById("logoPreview");
    preview.innerHTML = "";
    processedLogoBlob = null;
    document.getElementById("colorPreview").innerHTML = "";

    if (!file) return;

    const img = new Image();
    const reader = new FileReader();

    reader.onload = (event) => { img.src = event.target.result; };
    reader.readAsDataURL(file);

    img.onload = async () => {
      // Show preview
      preview.innerHTML = `<img src="${img.src}" style="max-width:120px;max-height:120px;border-radius:7px;border:1px solid #ccc;margin-top:8px;">`;

      // --- Extract palette using Vibrant.js ---
      try {
        const palette = await Vibrant.from(img).getPalette();
        let primary = palette.Vibrant ? palette.Vibrant.getHex() : '#142b47';
        let secondary = palette.LightVibrant ? palette.LightVibrant.getHex() : tinycolor(primary).lighten(25).toHexString();
        let dark = palette.DarkVibrant ? palette.DarkVibrant.getHex() : tinycolor(primary).darken(40).toHexString();

        // If the logo is basically single-color, generate variations:
        if (
          primary === secondary ||
          tinycolor.equals(primary, secondary)
        ) secondary = tinycolor(primary).lighten(25).toHexString();
        if (
          primary === dark ||
          tinycolor.equals(primary, dark)
        ) dark = tinycolor(primary).darken(40).toHexString();

        // Guarantee readable text
        let textColor = tinycolor.mostReadable(dark, ["#fff", "#222"]).toHexString();

        // Show swatch preview
        document.getElementById("colorPreview").innerHTML = `
          <div style="margin:10px 0;display:flex;justify-content:center;gap:12px;">
            <span style="display:inline-block;width:34px;height:22px;background:${primary};border-radius:6px;" title="Primary"></span>
            <span style="display:inline-block;width:34px;height:22px;background:${secondary};border-radius:6px;" title="Secondary"></span>
            <span style="display:inline-block;width:34px;height:22px;background:${dark};border-radius:6px;" title="Dark"></span>
            <span style="display:inline-block;width:34px;height:22px;background:${textColor};border-radius:6px;border:1px solid #eee;" title="Text"></span>
          </div>
          <div style="color:${textColor};font-size:0.93em">Preview: main, accent, background, text</div>
        `;

        // Fill hidden color fields (these get submitted!)
        document.getElementById('primaryColor').value = primary;
        document.getElementById('secondaryColor').value = secondary;
        document.getElementById('darkColor').value = dark;

      } catch (err) {
        document.getElementById("colorPreview").innerHTML = '<span style="color:#ff5050">Could not extract colors, using defaults.</span>';
        document.getElementById('primaryColor').value = "#142b47";
        document.getElementById('secondaryColor').value = "#fdd835";
        document.getElementById('darkColor').value = "#0d1b2a";
      }

      // --- Process for logo upload ---
      const canvas = document.createElement("canvas");
      const maxSize = 300;
      const scale = Math.min(maxSize / img.width, maxSize / img.height);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(
        (blob) => { processedLogoBlob = blob; },
        "image/webp",
        0.85
      );
    };
  });
  </script>

  <script>
  // === SUPABASE SETUP ===
  const supabaseUrl = 'https://vainwbdealnttojooghw.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhaW53YmRlYWxudHRvam9vZ2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNTc3MjAsImV4cCI6MjA2NTkzMzcyMH0.xewtWdupuo6TdQBHwGsd1_Jj6v5nmLbVsv_rc-RqqAU';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  document.getElementById('addClientForm').onsubmit = async function (e) {
    e.preventDefault();
    document.querySelector(".submit-btn").disabled = true;
setTimeout(() => { document.querySelector(".submit-btn").disabled = false; }, 4000);

    const msg = document.getElementById('formMessage');
    const loader = document.getElementById('formLoader');
    msg.style.color = "#fdd835";
    msg.textContent = "Creating client...";
    loader.style.display = "inline-block";

    let isDone = false;
    let isStillWorkingShown = false;
    const stillWorking = setTimeout(() => {
      if (!isDone) {
        msg.style.color = "#1ecbe1";
        msg.textContent = "Still working...";
        isStillWorkingShown = true;
      }
    }, 6000); // 6 seconds for "Still working..."

    const giveUp = setTimeout(() => {
      if (!isDone) {
        loader.style.display = "none";
        msg.style.color = "#ff5050";
        msg.textContent = "Request timed out. Please try again or check your connection.";
        isDone = true;
      }
    }, 20000);

    try {
      // 1. Gather form fields
      const clientName = document.getElementById('clientName').value.trim();
      const primary_color = document.getElementById('primaryColor').value;
      const secondary_color = document.getElementById('secondaryColor').value;
      const dark_color = document.getElementById('darkColor').value;
      const adminUsername = document.getElementById('adminUsername').value.trim();
      const adminPassword = document.getElementById('adminPassword').value;

      // 2. Upload logo to GitHub (jsDelivr) if present
      let logo_url = null;
      if (processedLogoBlob) {
        // Convert Blob to Base64
        const toBase64 = (blob) =>
          new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });

        const base64Image = await toBase64(processedLogoBlob);

        // Generate safe filename and path
        const fileName = clientName.replace(/\s+/g, '_').toLowerCase() + '.webp';
        const githubPath = `logos/${fileName}`;
        const jsDelivrUrl = `https://cdn.jsdelivr.net/gh/tweaver9/Nexus_ResQ-site/${githubPath}`;

        // --- Replace this with your real GitHub token ---
        const githubToken = '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';
        const githubApiUrl = `https://api.github.com/repos/tweaver9/Nexus_ResQ-site/contents/${githubPath}`;

        const githubUpload = await fetch(githubApiUrl, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${githubToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Add logo for ${clientName}`,
            content: base64Image,
            branch: "main"
          })
        });

        if (!githubUpload.ok) {
          const response = await githubUpload.json();
          throw new Error("GitHub upload failed: " + (response.message || githubUpload.statusText));
        }

        logo_url = jsDelivrUrl;
      }

      // 3. Insert client (with all colors!)
      const { data: client, error: clientErr } = await supabase
        .from('clients')
        .insert([{ name: clientName, logo_url, primary_color, secondary_color, dark_color }])
        .select()
        .single();

      if (clientErr || !client) {
        throw new Error(clientErr?.message || "Unknown error creating client");
      }

      // 4. Insert admin user
      const { error: userErr } = await supabase
        .from('users')
        .insert([{ username: adminUsername, password: adminPassword, role: 'admin', tenant_id: client.id }]);

      if (userErr) {
        throw new Error("Client created, but failed to add admin user: " + userErr.message);
      }

      isDone = true;
      clearTimeout(stillWorking);
      clearTimeout(giveUp);
      loader.style.display = "none";
  msg.style.color = "#28e640";
  msg.innerHTML = `✅ Client onboarded!<br>
      UUID: <code style="font-size:1.01em">${client.id}</code><br>
      <a href="https://${client.name}.nexusresq.com/login.html" target="_blank"
      style="color:#fdd835;text-decoration:underline;">Test client login &rarr;</a>`;


      // --- Show Return to Client Portal button ---
document.getElementById('returnToPortalBtn').style.display = '';

    } catch (err) {
      isDone = true;
      clearTimeout(stillWorking);
      clearTimeout(giveUp);
      loader.style.display = "none";
      msg.style.color = "#ff5050";
      msg.textContent = "❌ " + (err.message || err || "Unknown error");
    }
  }
  </script>

</body>
</html>
