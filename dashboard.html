<!DOCTYPE html>
<html>
<head>
  <title>Dashboard | NexusResQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const role = sessionStorage.getItem('role');
  const username = sessionStorage.getItem('username');
<body>
  <div class="dashboard-header">
    <span id="welcome-message"></span>
  </div>
  <div class="dashboard-menu">
    <button onclick="window.location.href='manage-users.html'">Manage Users</button>
    <button onclick="window.location.href='inspection-logs.html'">View Inspection Logs</button>
    <button onclick="window.location.href='help.html'">Help</button>
    <a class="logout-btn" href="index.html" onclick="sessionStorage.clear();">Log Out</a>
  </div>
</body>
  // Welcome message
  document.getElementById('welcome-message').textContent = "Welcome, " + (username ? username : "User") + "!";

  if (role === 'admin') {
    document.getElementById('admin-controls').style.display = 'block';
    document.getElementById('manage-users-btn').onclick = openUserManager;
  }

  // Simple Modal Handler
  function openModal(html) {
    const modal = document.getElementById('user-modal');
    document.getElementById('user-modal-content').innerHTML = html;
    modal.style.display = 'block';
    modal.onclick = (e) => {
      if(e.target === modal) modal.style.display = 'none';
    };
  }

  // User Manager
  async function openUserManager() {
    // Get all users
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'listUsers', adminRole: role })
    });
    const result = await res.json();
    if (!result.success) return alert(result.message);

    let userListHTML = '<h3>User List</h3><ul>';
    for(const user of result.users) {
      userListHTML += `
        <li>
          ${user.username} (${user.role}) 
          <button onclick="viewUser('${user.username}')">View/Modify</button>
          <button onclick="deleteUser('${user.username}')">Delete</button>
        </li>`;
    }
    userListHTML += '</ul><button onclick="addUserPopup()">Add User</button>';

    openModal(userListHTML);
  }

  // Expose user functions globally for modal buttons
  window.addUserPopup = function() {
    openModal(`
      <h3>Add User</h3>
      <form id="addUserForm">
        <input type="text" id="newUsername" placeholder="Username" required><br>
        <input type="password" id="newPassword" placeholder="Password" required><br>
        <select id="newRole"><option value="user">User</option><option value="admin">Admin</option></select><br>
        <button type="submit">Add</button>
        <button type="button" onclick="document.getElementById('user-modal').style.display='none'">Cancel</button>
      </form>
      <div id="addUserError"></div>
    `);
    document.getElementById('addUserForm').onsubmit = async function(e) {
      e.preventDefault();
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;
      const newRole = document.getElementById('newRole').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'addUser',
          username: newUsername,
          password: newPassword,
          role: newRole,
          adminRole: sessionStorage.getItem('role')
        })
      });
      const result = await res.json();
      if (result.success) {
        openUserManager();
      } else {
        document.getElementById('addUserError').textContent = result.message;
      }
    }
  };

  window.deleteUser = async function(user) {
    if(!confirm("Delete user: " + user + "?")) return;
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'deleteUser', targetUser: user, adminRole: sessionStorage.getItem('role') })
    });
    const result = await res.json();
    if(result.success) openUserManager();
    else alert(result.message);
  };

  window.viewUser = async function(user) {
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'viewUser', targetUser: user, adminRole: sessionStorage.getItem('role') })
    });
    const result = await res.json();
    if (!result.success) return alert(result.message);

    openModal(`
      <h3>User: ${result.user.username}</h3>
      <p>Role: ${result.user.role}</p>
      <p>Last Login: ${result.user.last_login ? new Date(result.user.last_login).toLocaleString() : 'Never'}</p>
      <button onclick="changePasswordPopup('${result.user.username}')">Change Password</button>
      <button onclick="document.getElementById('user-modal').style.display='none'">Close</button>
    `);
  };

  window.changePasswordPopup = function(user) {
    openModal(`
      <h3>Change Password for ${user}</h3>
      <form id="changePwForm">
        <input type="password" id="newPw" placeholder="New Password" required>
        <button type="submit">Change</button>
        <button type="button" onclick="document.getElementById('user-modal').style.display='none'">Cancel</button>
      </form>
      <div id="changePwError"></div>
    `);
    document.getElementById('changePwForm').onsubmit = async function(e) {
      e.preventDefault();
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'changePassword',
          targetUser: user,
          newPassword: document.getElementById('newPw').value,
          adminRole: sessionStorage.getItem('role')
        })
      });
      const result = await res.json();
      if (result.success) {
        openUserManager();
      } else {
        document.getElementById('changePwError').textContent = result.message;
      }
    }
  };

});
</script>

</body>
</html>
