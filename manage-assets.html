<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Assets | Nexus Res-Q</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="CSS/dashboard.css">
  <style>
    body { background: #0d1b2a; color: #f2f2f2; font-family: 'Oswald', sans-serif; margin: 0; padding: 0; }
    .assets-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 36px 0 36px; background: #142b47; border-bottom: 2px solid #223052; }
    .assets-header h1 { color: #fdd835; font-size: 2.2em; font-weight: 600; margin: 0; letter-spacing: 1px; }
    .assets-header .header-right { display: flex; align-items: center; gap: 24px; }
    .assets-action-btn { background: #fdd835; color: #142b47; border: none; border-radius: 6px; padding: 8px 20px; font-size: 1.07em; font-family: inherit; font-weight: 600; cursor: pointer; margin-right: 6px; transition: background 0.16s, color 0.16s; }
    .assets-action-btn:hover { background: #ffe066; }
    .assets-container { max-width: 1180px; margin: 32px auto 0 auto; padding: 0 16px 48px 16px; }
    .assets-toolbar { display: flex; align-items: center; gap: 24px; margin-bottom: 18px; }
    .assets-toolbar input[type="search"] { font-size: 1em; padding: 6px 12px; border-radius: 7px; border: 1px solid #344267; background: #192841; color: #fff; width: 220px; outline: none; }
    .assets-table { width: 100%; border-collapse: collapse; background: #16243c; border-radius: 14px; overflow: hidden; box-shadow: 0 6px 32px 0 #0a1322c5; margin-top: 6px; }
    .assets-table th, .assets-table td { padding: 14px 8px; text-align: left; }
    .assets-table th { background: #223052; color: #fdd835; font-weight: 600; font-size: 1.08em; }
    .assets-table tr { border-bottom: 1px solid #223052; transition: background 0.18s; }
    .assets-table tr:hover { background: #1e2f4b; }
    .status-badge { display: inline-block; border-radius: 5px; padding: 2px 9px; font-size: 0.95em; font-weight: 600; }
    .status-inservice { background: #28e64033; color: #28e640; }
    .status-outofservice { background: #ff505022; color: #ff5050; }
    .status-failed { background: #ffd83533; color: #fdd835; }
    .status-moved { background: #bbb; color: #444; }
    .action-btn { background: #142b47; color: #fdd835; border: none; border-radius: 6px; padding: 5px 15px; font-size: 1em; font-family: inherit; font-weight: 500; cursor: pointer; margin-right: 8px; transition: background 0.15s, color 0.15s; }
    .action-btn:hover { background: #fdd835; color: #142b47; }
    @media (max-width: 900px) {
      .assets-header, .assets-container { padding-left: 6px; padding-right: 6px; }
      .assets-header h1 { font-size: 1.6em; }
      .assets-table th, .assets-table td { padding: 7px 3px; }
    }
    @media (max-width: 600px) {
      .assets-header { flex-direction: column; align-items: flex-start; }
      .header-right { flex-direction: column; align-items: flex-start; gap: 10px;}
      .assets-container { padding: 0 2px; }
      .assets-table { font-size: 0.97em; }
    }
    #modal-root { position: fixed; left:0;top:0;width:100vw;height:100vh;z-index:90;display:none;align-items:center;justify-content:center;background:rgba(14,16,32,.58);}
  </style>
</head>
<body>
  <header class="assets-header">
    <h1>Manage Assets</h1>
    <div class="header-right">
      <button class="assets-action-btn" id="addAssetBtn">+ Add Asset</button>
      <button class="assets-action-btn" id="addTypeBtn">+ Add Type</button>
      <button class="assets-action-btn" id="addLocationBtn">+ Add Location</button>
      <!-- ADMIN EXPANSION: Add/Remove Clients, Users, Permissions, etc. -->
    </div>
  </header>
  <main>
    <div class="assets-container">
      <div class="assets-toolbar">
        <input type="search" id="assetSearch" placeholder="Search by ID, location, or type...">
      </div>
      <table class="assets-table" id="assetsTable">
        <thead>
          <tr>
            <th>Client</th>
            <th>Status</th>
            <th>Asset ID</th>
            <th>Type</th>
            <th>Location</th>
            <th>Assigned User</th>
            <th>Last Inspected By</th>
            <th>Last Inspection</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="assetsTableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
      <div id="noAssetsMsg" style="margin-top:20px; color:#fdd835; text-align:center; display:none;">No assets found in this area.</div>
    </div>
  </main>
  <div id="modal-root"></div>
  <script type="module">
    // ----------- FIREBASE IMPORTS -----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, updateDoc, doc, serverTimestamp, query
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ----------- YOUR FIREBASE CONFIG HERE -----------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ========== STATE ==========
    let allClients = [];
    let allAssets = [];
    let assetTypesCache = {};
    let locationsCache = {};

    // ========== DOM ==========
    const assetsTableBody = document.getElementById('assetsTableBody');
    const noAssetsMsg = document.getElementById('noAssetsMsg');
    const assetSearch = document.getElementById('assetSearch');
    const modalRoot = document.getElementById('modal-root');
    const addAssetBtn = document.getElementById('addAssetBtn');
    const addTypeBtn = document.getElementById('addTypeBtn');
    const addLocationBtn = document.getElementById('addLocationBtn');

    // ========== LOAD DATA ==========
    window.addEventListener('DOMContentLoaded', async () => {
      await loadAllClients();
      await loadAllAssets();
      assetSearch.addEventListener('input', renderAssets);
      addAssetBtn.onclick = showAddAssetModal;
      addTypeBtn.onclick = showAddTypeModal;
      addLocationBtn.onclick = showAddLocationModal;
    });

    async function loadAllClients() {
      const snap = await getDocs(collection(db, "clients"));
      allClients = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Preload assetTypes and locations for dropdown performance
      for (const c of allClients) {
        assetTypesCache[c.id] = await getTypesForClient(c.id);
        locationsCache[c.id] = await getLocationsForClient(c.id);
      }
    }

    async function loadAllAssets() {
      allAssets = [];
      // Load all assets from all clients
      for (const client of allClients) {
        const snap = await getDocs(collection(db, `clients/${client.id}/assets`));
        snap.forEach(doc => {
          allAssets.push({
            ...doc.data(),
            id: doc.id,
            clientId: client.id,
            clientName: client.name || client.id
          });
        });
      }
      renderAssets();
    }

    // ========== HELPERS ==========
    async function getTypesForClient(clientId) {
      const snap = await getDocs(collection(db, `clients/${clientId}/assetTypes`));
      return snap.docs.map(d => d.data().name);
    }
    async function getLocationsForClient(clientId) {
      const snap = await getDocs(collection(db, `clients/${clientId}/locations`));
      return snap.docs.map(d => d.data().name);
    }

    // ========== RENDER ASSET TABLE ==========
    function renderAssets() {
      const searchVal = assetSearch.value.trim().toLowerCase();
      let filtered = allAssets;
      if (searchVal) {
        filtered = filtered.filter(row =>
          (row.asset_id || '').toLowerCase().includes(searchVal) ||
          (row.type || '').toLowerCase().includes(searchVal) ||
          (row.location || '').toLowerCase().includes(searchVal) ||
          (row.assigned_user || '').toLowerCase().includes(searchVal) ||
          (row.clientName || '').toLowerCase().includes(searchVal)
        );
      }
      assetsTableBody.innerHTML = "";
      if (!filtered.length) {
        noAssetsMsg.style.display = "";
        return;
      }
      noAssetsMsg.style.display = "none";

      filtered.forEach(row => {
        assetsTableBody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${row.clientName}</td>
            <td>${statusBadge(row.status)}</td>
            <td>${row.asset_id || "—"}</td>
            <td>${row.type || "—"}</td>
            <td>${row.location || "—"}</td>
            <td>${row.assigned_user || "—"}</td>
            <td>${row.last_inspected_by || "—"}</td>
            <td>${row.last_inspection_date || "—"}</td>
            <td>
              <button class="action-btn" onclick="window.editAsset('${row.clientId}','${row.id}')">Edit</button>
              <button class="action-btn" onclick="window.deleteAsset('${row.clientId}','${row.id}')">Delete</button>
            </td>
          </tr>
        `);
      });
    }

    function statusBadge(status) {
      if (status === "in_service") return `<span class="status-badge status-inservice">In Service</span>`;
      if (status === "out_of_service") return `<span class="status-badge status-outofservice">Out</span>`;
      if (status === "failed") return `<span class="status-badge status-failed">Failed</span>`;
      if (status === "moved") return `<span class="status-badge status-moved">Moved</span>`;
      return `<span class="status-badge">${status || "—"}</span>`;
    }

    // ========== ADD ASSET MODAL (MULTI-CLIENT) ==========
    async function showAddAssetModal() {
      let clientOptions = allClients.map(c => `<option value="${c.id}">${c.name || c.id}</option>`).join('');
      modalRoot.innerHTML = `
        <div style="background:#223052;padding:32px 26px;border-radius:14px;max-width:480px;margin:60px auto;">
          <h3 style="color:#fdd835;">Add Asset (Any Client)</h3>
          <form id="addAssetForm">
            <label>Client</label>
            <select id="assetClient" required>
              <option value="">Select Client</option>
              ${clientOptions}
            </select>
            <label>Location</label>
            <select id="assetLocation" required>
              <option value="">Select Client First</option>
            </select>
            <label>Type</label>
            <select id="assetType" required>
              <option value="">Select Client First</option>
            </select>
            <label>Asset ID</label>
            <input type="text" id="assetId" required placeholder="e.g. Extinguisher001">
            <label>Serial No.</label>
            <input type="text" id="assetSerial" placeholder="Optional">
            <label>Status</label>
            <select id="assetStatus">
              <option value="in_service">In Service</option>
              <option value="out_of_service">Out of Service</option>
              <option value="moved">Moved</option>
            </select>
            <label>Assigned User</label>
            <input type="text" id="assignedUser" placeholder="Optional">
            <label>Last Inspected By</label>
            <input type="text" id="lastInspectedBy" placeholder="username">
            <label>Last Inspection Date</label>
            <input type="date" id="lastInspectionDate">
            <button class="assets-action-btn" type="submit">Add</button>
            <button class="action-btn" type="button" id="closeAssetModal">Cancel</button>
            <span id="assetFormMsg" style="margin-left:10px;color:#fdd835;"></span>
          </form>
        </div>
      `;
      modalRoot.style.display = "flex";
      document.getElementById('closeAssetModal').onclick = () => modalRoot.style.display = "none";

      // When client is picked, load its locations and types
      document.getElementById('assetClient').onchange = function() {
        const clientId = this.value;
        const locList = locationsCache[clientId] || [];
        const typeList = assetTypesCache[clientId] || [];
        document.getElementById('assetLocation').innerHTML = `<option value="">Select Location</option>` +
          locList.map(l => `<option value="${l}">${l}</option>`).join('');
        document.getElementById('assetType').innerHTML = `<option value="">Select Type</option>` +
          typeList.map(t => `<option value="${t}">${t}</option>`).join('');
      };

      document.getElementById('addAssetForm').onsubmit = async function(e) {
        e.preventDefault();
        const msg = document.getElementById('assetFormMsg');
        msg.textContent = "Adding...";
        const clientId = document.getElementById('assetClient').value;
        const location = document.getElementById('assetLocation').value.trim();
        const type = document.getElementById('assetType').value.trim();
        const asset_id = document.getElementById('assetId').value.trim();
        const serial = document.getElementById('assetSerial').value.trim();
        const assigned_user = document.getElementById('assignedUser').value.trim();
        const status = document.getElementById('assetStatus').value;
        const last_inspected_by = document.getElementById('lastInspectedBy').value.trim();
        const last_inspection_date = document.getElementById('lastInspectionDate').value;
        if (!clientId || !asset_id || !type || !location) {
          msg.textContent = "Fill all required fields.";
          msg.style.color = "#ff5050";
          return;
        }
        try {
          await addDoc(collection(db, `clients/${clientId}/assets`), {
            asset_id, type, location, serial, assigned_user, status,
            last_inspected_by, last_inspection_date,
            created_at: serverTimestamp()
          });
          msg.textContent = "Added!";
          msg.style.color = "#28e640";
          modalRoot.style.display = "none";
          await loadAllAssets();
        } catch (error) {
          msg.textContent = "Error: " + (error.message || "Unknown error");
          msg.style.color = "#ff5050";
        }
      };
    }

    // ========== ADD TYPE MODAL (PER CLIENT) ==========
    function showAddTypeModal() {
      let clientOptions = allClients.map(c => `<option value="${c.id}">${c.name || c.id}</option>`).join('');
      modalRoot.innerHTML = `
        <div style="background:#223052;padding:32px 26px;border-radius:14px;max-width:360px;margin:60px auto;">
          <h3 style="color:#fdd835;">Add Asset Type</h3>
          <form id="addTypeForm">
            <label>Client</label>
            <select id="typeClient" required>
              <option value="">Select Client</option>
              ${clientOptions}
            </select>
            <label>Name</label>
            <input type="text" id="typeName" required placeholder="e.g. Fire Extinguisher">
            <button class="assets-action-btn" type="submit">Add</button>
            <button class="action-btn" type="button" id="closeTypeModal">Cancel</button>
            <span id="typeFormMsg" style="margin-left:10px;color:#fdd835;"></span>
          </form>
        </div>
      `;
      modalRoot.style.display = "flex";
      document.getElementById('closeTypeModal').onclick = () => modalRoot.style.display = "none";
      document.getElementById('addTypeForm').onsubmit = async function (e) {
        e.preventDefault();
        const msg = document.getElementById('typeFormMsg');
        msg.textContent = "Adding...";
        const clientId = document.getElementById('typeClient').value;
        const name = document.getElementById('typeName').value.trim();
        if (!clientId || !name) {
          msg.textContent = "Fill out all fields.";
          msg.style.color = "#ff5050";
          return;
        }
        try {
          await addDoc(collection(db, `clients/${clientId}/assetTypes`), { name, created_at: serverTimestamp() });
          msg.textContent = "Added!";
          msg.style.color = "#28e640";
          assetTypesCache[clientId] = await getTypesForClient(clientId);
          modalRoot.style.display = "none";
        } catch (error) {
          msg.textContent = "Error: " + (error.message || "Unknown error");
          msg.style.color = "#ff5050";
        }
      };
    }

    // ========== ADD LOCATION MODAL (PER CLIENT) ==========
    function showAddLocationModal() {
      let clientOptions = allClients.map(c => `<option value="${c.id}">${c.name || c.id}</option>`).join('');
      modalRoot.innerHTML = `
        <div style="background:#223052;padding:32px 26px;border-radius:14px;max-width:360px;margin:60px auto;">
          <h3 style="color:#fdd835;">Add Location/Zone/Area</h3>
          <form id="addLocationForm">
            <label>Client</label>
            <select id="locationClient" required>
              <option value="">Select Client</option>
              ${clientOptions}
            </select>
            <label>Name</label>
            <input type="text" id="locationName" required placeholder="e.g. Office 1">
            <button class="assets-action-btn" type="submit">Add</button>
            <button class="action-btn" type="button" id="closeLocationModal">Cancel</button>
            <span id="locationFormMsg" style="margin-left:10px;color:#fdd835;"></span>
          </form>
        </div>
      `;
      modalRoot.style.display = "flex";
      document.getElementById('closeLocationModal').onclick = () => modalRoot.style.display = "none";
      document.getElementById('addLocationForm').onsubmit = async function (e) {
        e.preventDefault();
        const msg = document.getElementById('locationFormMsg');
        msg.textContent = "Adding...";
        const clientId = document.getElementById('locationClient').value;
        const name = document.getElementById('locationName').value.trim();
        if (!clientId || !name) {
          msg.textContent = "Fill out all fields.";
          msg.style.color = "#ff5050";
          return;
        }
        try {
          await addDoc(collection(db, `clients/${clientId}/locations`), {
            name,
            created_at: serverTimestamp()
          });
          msg.textContent = "Added!";
          msg.style.color = "#28e640";
          locationsCache[clientId] = await getLocationsForClient(clientId);
          modalRoot.style.display = "none";
        } catch (error) {
          msg.textContent = "Error: " + (error.message || "Unknown error");
          msg.style.color = "#ff5050";
        }
      };
    }

    // ========== EDIT / DELETE ASSET ==========
    window.editAsset = function(clientId, assetId) {
      alert(`Edit asset: ${assetId} for client: ${clientId}\n(This feature coming soon)`);
    };
    window.deleteAsset = async function(clientId, assetId) {
      if (!confirm('Delete this asset?')) return;
      try {
        await updateDoc(doc(db, `clients/${clientId}/assets/${assetId}`), { deleted: true });
        await loadAllAssets();
      } catch (error) {
        alert('Failed to delete asset.');
      }
    };

    // ========== ADMIN EXPANSION POINTS ==========
    // Add similar modal logic for clients, users, questions, roles, permissions, assignments, etc.

  </script>
</body>
</html>
